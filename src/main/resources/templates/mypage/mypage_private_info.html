<article id="mypage_private_info">
    <header>
        <h3><a href="#">개인정보수정</a></h3>
    </header>
    <section>
        <form action="/mypage/infoEdit" method="post">
            <table class="default edit_info">
                <tr>
                    <td>
                        <label for="name">이름 <b>*</b></label>
                    </td>
                    <td>
                        <input id="name" th:value="${member.name}" type="text" name="name"/>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="birth_date">생년월일 <b>*</b></label>
                    </td>
                    <td>
                        <input id="birth_date" th:value="${member.age}" type="text" name="age"/>
                        <div>
                            <ul>
                                <li>생일 쿠폰은 생일 당월 동안 사용 가능합니다.</li>
                                <li>생일은 연 2회 수정 가능하며, 쿠폰 사용 전 수정한 경우 수정한 월을 기준으로 재발급 됩니다.</li>
                            </ul>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <label for="email">이메일 <b>*</b></label></td>
                    <td>
                        <input id="email" th:value="${member.email}" type="text" name="email"/>
                        <button class="button" id="checkEmail">중복 확인</button>
                        <div>
                            <p id="email-available" style="color: #00C73C; display: none;">사용가능한 이메일 입니다.</p>
                            <p id="email-taken" style="color: #ff0000; display: none;">사용 중인 이메일 입니다.</p>
                        </div>
                    </td>
                </tr>
                <tr th:if="${formUser == 'formUser'}">
                    <td>
                        <label for="password_chk">패스워드 확인 <b>*</b></label>
                    </td>
                    <td>
                        <input id="password_chk" type="password" name="password"/>
                    </td>
                </tr>
            </table>
            <div class="info_submit_box">
                <button class="button" type="reset">취소하기</button>
                <button class="button" type="submit" id="submitButton">저장하기</button>
            </div>
        </form>
    </section>
</article>

<script th:inline="javascript">
    const memberJson = [[${memberJson}]];
    const member = JSON.parse(memberJson);

    $(document).ready(function() {
        var checkEmailButton = null; // 이메일 중복확인 버튼 누르기 + 사용가능한 이메일(1) 체크용
        $('#checkEmail').click(function(e) {
            e.preventDefault(); // 폼 제출 방지

            var email = $('#email').val();

            $.ajax({
                type: 'POST',
                url: '/mypage/infoEditCheckEmail',
                data: JSON.stringify({email: email}),
                contentType: 'application/json',
                success: function(response) {
                    if(response.available) {
                        $('#email-available').show();
                        $('#email-taken').hide();
                        checkEmailButton = 1;
                    } else {
                        $('#email-available').hide();
                        $('#email-taken').show();
                        checkEmailButton = null;
                    }
                },
                error: function() {
                    alert('이메일 확인 중 오류가 발생했습니다.');
                }
            });
        });

        $('#submitButton').click(function(e) {
            e.preventDefault(); // 폼 제출 방지

            const name = $('#name').val();
            const birth_date = $('#birth_date').val();
            const email = $('#email').val();
            const password_chk = $('#password_chk').val();

            if(checkEmailButton === 1) {
                $.ajax({
                    type: 'POST',
                    url: '/mypage/infoEdit',
                    data: {
                        id: member.id,
                        name: name,
                        email: email,
                        age: birth_date,
                        // password: password_chk,
                        password: member.password,
                        social: member.social,
                        grade_code: member.grade_code,
                        checkedTermsE: member.checkedTermsE,
                        checkedTermsS: member.checkedTermsS
                    },
                    success: function(response) {
                        $('#content').html(response);
                    },
                    error: function(xhr, status, error) {
                        console.error('Update Info Error:', error);
                    }
                })
            } else {
                alert("이메일 중복 확인을 해주세요.")
            }
        });
    });
</script>