
<!DOCTYPE html>
<html lang="en" layout:decorate="~{layout/layout_total}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Cinemacast</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/custom.css" />
    <link rel="stylesheet" href="/assets/css/custom_player.css" />
    <link rel="stylesheet" href="/assets/css/nav.css" />
    <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
    <!--    ëŒ“ê¸€-->

    <style>

        .hide {
            display: none;
        }

        .still-cut-article img {
            max-width: 100%;
            max-height: 100%;
        }

        /* ì´ë¯¸ì§€í´ë¦­ì‹œ ë„ìš°ëŠ” ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999999;
            padding-top: 60px;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0, 0, 0);
            background-color: rgba(0, 0, 0, 0.9);
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 100%;
            max-width: 1200px;
        }

        .close {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
        }

        .close:hover,
        .close:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }

        /* ë¹„ë””ì˜¤ ëª¨ë‹¬ ê´€ë ¨ CSS */
        .video-modal-content {
            width: 80%; /* ëª¨ë‹¬ ë„ˆë¹„, í•„ìš”ì— ë”°ë¼ ì¡°ì • */
            max-width: 640px; /* ìµœëŒ€ ë„ˆë¹„, í•„ìš”ì— ë”°ë¼ ì¡°ì • */
        }

        #videoFrame {
            width: 100%; /* iframeì˜ ë„ˆë¹„ë¥¼ ë¶€ëª¨ ìš”ì†Œì— ë§ì¶¤ */
            height: 720px; /* ë†’ì´, í•„ìš”ì— ë”°ë¼ ì¡°ì • */
        }


        .video-modal-content {
            width: 100%; /* ì˜ìƒ í¬ê¸° ì¡°ì • */
            max-width: 1280px; /* ìµœëŒ€ í¬ê¸° ì„¤ì • */
            margin: auto; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%); /* í™”ë©´ ì¤‘ì•™ ì •ë ¬ */
            z-index: 1000; /* í•„ìš”ì— ë”°ë¼ ì¡°ì • */
        }


    </style>
</head>
<body class="right-sidebar is-preload">
<th:block layout:fragment="content">
    <div id="page-wrapper">

        <header data-include-path="./header.html"></header>

        <!-- Main -->
        <div class="wrapper style1">

            <div class="container" th:each="movie, iterStat : ${movieInfos}">
                <input type="hidden" id="movieId" th:value="${movie.id}">
                <div class="row">
                    <div class="col-12-mobile" id="content">
                        <article id="main">
                            <div class="movie_info_background" >
                                <header id="get_info">
                                    <a href="#" class="image featured">
                                        <img th:src="@{'https://image.tmdb.org/t/p/w500' + ${movie.posterPath}}" alt="ì˜í™”í¬ìŠ¤í„°"
                                             th:onclick="'openModal(\'' + @{'https://image.tmdb.org/t/p/original' + ${movie.posterPath}} + '\')'"
                                             style="width: 400px; height: 600px;" /></a>
                                    <div class="movie_info">
                                        <div class="info_header">
                                            <h2 th:text="${movie.title}" class="movie_title"></h2>
                                            <a href="#" class="button" style="height: 3em;">ì§€ê¸ˆ ì˜ˆë§¤í•˜ê¸°</a>
                                        </div>
                                        <span th:text="${movie.releaseDate} + ' | '">releasedate</span>
                                        <span th:text="${movie.genres} + ' | '">genres</span>
                                        <span th:text="${movie.runtime} + 'ë¶„'">runtime</span>
                                        <div style="text-align: right;">
                                            <!--                                    <a th:href="@{'https://www.youtube.com/watch?v=' + ${movie.video}}" class="button" style="height: 3em;">íŠ¸ë ˆì¼ëŸ¬ ë³´ê¸°</a>-->
                                            <button id="videoModalBtn" class="button" style="height: 3em;" th:data-video-id="${movie.video}">íŠ¸ë ˆì¼ëŸ¬ ë³´ê¸°</button>
                                        </div>
                                        <p><b>ê°ë… : </b>director <b>ê°ë³¸ : </b>writer</p>

                                        <p th:text="${movie.overview}">
                                            ~ overview ~
                                        </p>

                                        <div class="movie_data_box">
                                            <div class="movie_data">
                                                <h4>ëˆ„ì  ê´€ê°ìˆ˜</h4>
                                                <p>cnv</p>
                                            </div>
                                            <div class="movie_data">
                                                <h4>ì¸ê¸°ë„</h4>
                                                <p th:text="${movie.popularity}">popularity (%)</p>
                                            </div>
                                            <div class="movie_data_averageRating">
                                                <h4>í‰ì </h4>
                                                <!--                                        <p th:text="${movie.voteAverage}">vote rating</p>-->
                                            </div>
                                        </div>
                                    </div>
                                </header>
                            </div>
                            <h3>ì¶œì—°ì§„</h3>
                            <div id="movie-info">
                            </div>
                        </article>
                    </div>
                </div>

                <!-- ë¹„ë””ì˜¤ íŠ¸ë ˆì¼ëŸ¬ ëª¨ë‹¬ -->
                <div id="videoModal" class="modal">
                    <div class="video-modal-content">
                        <span class="close">&times;</span>
                        <iframe id="videoFrame" width="560" height="315" src="" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>

                <button type="button" onclick="addReaction(1, `${movieId}`, 'LIKE')">ì¢‹ì•„ìš”</button>
                <span id="likeCount_${movie.id}">0</span>
                <button type="button" onclick="addReaction(1, `${movieId}`, 'SAD')">ìŠ¬í¼ìš”</button>
                <span id="sadCount_${movie.id}">0</span> <!-- ì´ˆê¸°ê°’ì„ 0ìœ¼ë¡œ ì„¤ì • -->


                <section class="movie_etc">
                    <div class="etc_btn">
                        <button type="button" class="button stillcut_btn clicked">ìŠ¤í‹¸ì»·</button>
                        <button type="button" class="button reviews_btn">ë¦¬ë·°</button>
                    </div>
                </section>

                <!-- ìŠ¤í‹¸ì»· for each (ë°˜ë³µ) -->
                <div id="stillcut" th:each="movie, iterStat : ${movieInfos}" >
                    <div class="row">
                        <div th:each="stillCutPath, iterStat : ${movie.stillCutPaths}" th:class="${iterStat.count > 4} ? 'hide stillCut' : 'stillCut'" >
                            <article class="col-4 col-12-mobile special still-cut-article">
                                <a href="#" class="image featured">
                                    <img th:src="@{'https://image.tmdb.org/t/p/original/' + ${stillCutPath}}" alt="ìŠ¤í‹¸ì»·"
                                         onclick="openModal(this.getAttribute('src'))"
                                    />
                                </a>
                            </article>
                        </div>
                    </div>
                    <p id="showMore" style="cursor: pointer;"><a>more</a></p>
                    <p id="showLess" style="cursor: pointer; display:none;"><a>ì ‘ê¸°</a></p>
                </div>
                <div id="reviews" style="display: none">
                    <button onclick="openReviewModal()" class="modal_open">ê´€ëŒí‰ ì‘ì„±í•˜ê¸°</button>
                    <div class="row">
                        <table class="default" id="reviews-table">
                            <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ì¶”ê°€ë  ê²ƒì…ë‹ˆë‹¤ -->
                        </table>
                        <!--ìŠ¤í‹¸ì»· ë”ë³´ê¸° ì ‘ê¸°-->
                    </div>
                    <p id="showMore_review" style="cursor: pointer;"><a>more</a></p>
                    <p id="showLess_review" style="cursor: pointer; display:none;"><a>ì ‘ê¸°</a></p>
                </div>
                <!-- ì´ë¯¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ -->
                <div id="myModal" class="modal">
                    <span class="close" onclick="closeModal()">&times;</span>
                    <img class="modal-content" id="modalImage">
                </div>
            </div>
        </div>
        <footer data-include-path="footer.html"></footer>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.dropotron.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/jquery.scrollex.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>



    <!--              ëŒ“ê¸€         ------------------             -->
    <script>
        // include.js
        window.addEventListener('load', function () {
            var allElements = document.getElementsByTagName('*');
            Array.prototype.forEach.call(allElements, function (el) {
                var includePath = el.dataset.includePath;
                if (includePath) {
                    var xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = function () {
                        if (this.readyState == 4 && this.status == 200) {
                            el.outerHTML = this.responseText;
                        }
                    };
                    xhttp.open('GET', includePath, true);
                    xhttp.send();
                }
            });
        });
        // credits api ì œì‘ì§„ ì‚¬ì§„
        const options = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3N2UzMWU5NWVjZmE3ZjBlODY5YTE3NmQwMjU0YWQwMiIsInN1YiI6IjY2NDJiMWM1ZTJlZjM4N2Y1MjM1OTNjZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hBVsW7eVrC2M3FdWc2OJEAWq0h4v-NiiM2YEDQoy7OU'
            }
        };

        async function fetchMovieCredits(movieId) {

            try {
                const apiKey = '547e2cd4d0e26e68fb907dafef4f90ac';
                const url = `https://api.themoviedb.org/3/movie/${movieId}/credits?language=ko-KR&api_key=${apiKey}`;
                const response = await fetch(url);
                const data = await response.json();

                // ì˜í™” ì •ë³´ë¥¼ ë‹´ì„ ìš”ì†Œ ìƒì„±
                const movieInfoDiv = document.getElementById('movie-info');
                movieInfoDiv.style.display = 'flex'; // Flexbox ë ˆì´ì•„ì›ƒ ì ìš©
                movieInfoDiv.style.flexWrap = 'wrap'; // ìš”ì†Œë“¤ì´ ë„˜ì¹˜ë©´ ë‹¤ìŒ ì¤„ë¡œ ë„˜ê¹€

                // ê°ë… ì •ë³´ ì¶œë ¥ (ì´ë¯¸ì§€ í¬í•¨)
                const director = data.crew.find(person => person.job === 'Director');
                if (director) {
                    const directorDiv = createPersonDiv(director.name, director.profile_path, true);
                    movieInfoDiv.appendChild(directorDiv); // directorDivë¥¼ movieInfoDivì— ì¶”ê°€
                }

                // ì¶œì—°ì§„ ì •ë³´ ì¶œë ¥ (ì´ë¯¸ì§€ í¬í•¨)
                data.cast.slice(0, 5).forEach(cast => {
                    const castDiv = createPersonDiv(cast.name, cast.profile_path);
                    movieInfoDiv.appendChild(castDiv); // castDivë¥¼ movieInfoDivì— ì¶”ê°€
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // ì¸ë¬¼ ì •ë³´ì™€ ì´ë¯¸ì§€ë¥¼ ë‹´ì€ div ìƒì„± í•¨ìˆ˜
        function createPersonDiv(name, profilePath, isDirector = false) {
            const personDiv = document.createElement('div'); // ìƒˆë¡œìš´ div ìƒì„±
            personDiv.style.margin = '8px'; // ê°„ê²© ì„¤ì •
            personDiv.style.width = '200px';
            personDiv.style.height = '300px';

            const p = document.createElement('p');
            p.innerHTML = isDirector ? `<p>ê°ë… : ${name}</p>` : `<p>${name}</p>`;
            p.style.fontSize = '1em'; // ê¸€ì í¬ê¸° ì‘ê²Œ ì„¤ì •

            const img = document.createElement('img');
            img.src = `https://image.tmdb.org/t/p/w200${profilePath}`; // ì´ë¯¸ì§€ ê²½ë¡œ ì„¤ì •
            img.alt = `${name}'s profile image`;
            img.style.width = '100%';
            img.style.height = 'auto'; // ë†’ì´ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì •

            personDiv.appendChild(img);
            personDiv.appendChild(p);

            return personDiv;
        }
        //
        // const movieId = [[${movieId}]]
        //
        // fetchMovieCredits(movieId);

        const api = {
            method: 'GET',
            headers: {
                accept: 'application/json',
                Authorization: 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiI3N2UzMWU5NWVjZmE3ZjBlODY5YTE3NmQwMjU0YWQwMiIsInN1YiI6IjY2NDJiMWM1ZTJlZjM4N2Y1MjM1OTNjZCIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.hBVsW7eVrC2M3FdWc2OJEAWq0h4v-NiiM2YEDQoy7OU'
            }
        };


        // ìŠ¤í‹¸ì»· ë”ë³´ê¸°(more), ì ‘ê¸° í´ë¦­ í•¨ìˆ˜
        // í˜„ì¬ í‘œì‹œëœ í•­ëª©ì˜ ìˆ˜ë¥¼ ì¶”ì í•˜ëŠ” ë³€ìˆ˜
        var visibleCount = 4; // ì²˜ìŒì— ë³´ì´ëŠ” í•­ëª© ìˆ˜
        var increment = 8; // í•œ ë²ˆì— í‘œì‹œí•  ì¶”ê°€ í•­ëª© ìˆ˜

        document.getElementById("showMore").addEventListener("click", function () {
            var stillCuts = document.querySelectorAll(".stillCut");
            var newVisibleCount = Math.min(visibleCount + increment, stillCuts.length);

            for (var i = visibleCount; i < newVisibleCount; i++) {
                stillCuts[i].classList.remove("hide");
            }

            visibleCount = newVisibleCount; // ì—…ë°ì´íŠ¸ëœ í‘œì‹œëœ í•­ëª©ì˜ ìˆ˜

            // "ì ‘ê¸°" ë²„íŠ¼ì„ í•­ìƒ ë³´ì—¬ì¤Œ
            document.getElementById("showLess").style.display = 'block';

            // ëª¨ë“  í•­ëª©ì´ í‘œì‹œë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (visibleCount >= stillCuts.length) {
                // "ë”ë³´ê¸°"ë¥¼ ìˆ¨ê¹€
                this.style.display = 'none';
            } else {
                // ì•„ì§ í‘œì‹œë˜ì§€ ì•Šì€ í•­ëª©ì´ ìˆë‹¤ë©´ "ë”ë³´ê¸°"ë¥¼ ê³„ì† ë³´ì—¬ì¤Œ
                this.style.display = 'block';
            }
        });

        document.getElementById("showLess").addEventListener("click", function () {
            var stillCuts = document.querySelectorAll(".stillCut");
            for (var i = 0; i < stillCuts.length; i++) {
                if (i > 3) { // ì²˜ìŒ 4ê°œë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
                    stillCuts[i].classList.add("hide");
                }
            }
            visibleCount = 4; // "ì ‘ê¸°" í›„ ì²˜ìŒ í‘œì‹œëœ í•­ëª©ì˜ ìˆ˜ë¡œ ë¦¬ì…‹
            this.style.display = 'none'; // "ì ‘ê¸°"ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤.
            document.getElementById("showMore").style.display = 'block'; // "ë”ë³´ê¸°"ê°€ ë‹¤ì‹œ ë³´ì—¬ì§ˆ ìƒí™©ì„ ìœ„í•´
        });


        // ì´ë¯¸ì§€ í´ë¦­ì‹œ ì›ë³¸í¬ê¸°ë¡œ ë³¼ìˆ˜ìˆê²Œ ë„ìš°ëŠ” ëª¨ë‹¬ ê´€ë ¨ ë³€ìˆ˜ ë° í•¨ìˆ˜ë“¤
        var currentScrollPosition = 0;

        function openModal(imageSrc) {

            var header = document.getElementById("header")
            header.style.display = "hide"
            currentScrollPosition = window.scrollY;
            document.body.style.overflow = 'hide';
            var modal = document.getElementById("myModal");
            var modalImg = document.getElementById("modalImage");
            modal.style.display = "block";
            modalImg.src = imageSrc;
        }

        function closeModal() {
            var header = document.getElementById("header");
            header.style.display = '';
            var modal = document.getElementById("myModal");
            modal.style.display = "none";
            document.body.style.overflow = '';
            // ìê¾¸ ëª¨ë‹¬ ë‹«ì„ë•Œ í¬ìŠ¤í„° ì´ë¯¸ì§€ í¬ê¸°ê°€ ë°”ê»´ì„œ
            // ê± ëª¨ë‹¬ í•¨ìˆ˜ì—ì„œ ë‹«ì„ë•Œ í¬ìŠ¤í„°ì´ë¯¸ì§€ í¬ê¸°ë¥¼ ê°•ì œë¡œ ì„¤ì •í•´ì„œ í¬ê¸°ë³€ë™ì´ ì—†ëŠ”ê²ƒì²˜ëŸ¼ ë³´ì´ê²Œí•¨.
            document.querySelector('.image.featured img').style.width = '400px';
            document.querySelector('.image.featured img').style.height = '600px';

            window.scrollTo(0, currentScrollPosition);
        }

        /*--------- ì´ë¯¸ì§€ ìƒì„¸ë³´ê¸° ëª¨ë‹¬ ë --------*/

        /* ìœ íŠœë¸Œ íŠ¸ë ˆì¼ëŸ¬ ê´€ë ¨ ëª¨ë‹¬ ì‹œì‘ */

        //     document.getElementById('videoModalBtn').addEventListener('click', function() {
        //     var modal = document.getElementById('videoModal');
        //     var videoUrl = 'https://www.youtube.com/watch?v=' + '@{${movie.video}}';
        //     document.getElementById('videoFrame').src = videoUrl;
        //     modal.style.display = "block";
        // });
        //
        //     document.getElementsByClassName('close')[0].addEventListener('click', function() {
        //     document.getElementById('videoModal').style.display = "none";
        //     document.getElementById('videoFrame').src = ""; // ë¹„ë””ì˜¤ ì •ì§€
        // });

        // ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œ íƒ€ì„ë¦¬í”„ë¥¼ ì´ìš©í•œ ë³€ìˆ˜ ê°€ì ¸ì˜¤ê¸°ìœ„í•œ ì½”ë“œ í¬í•¨
        document.addEventListener('DOMContentLoaded', function() {
            var openModalButton = document.getElementById('videoModalBtn');
            if (openModalButton) {
                openModalButton.addEventListener('click', function() {
                    var modal = document.getElementById('videoModal');
                    var videoId = openModalButton.getAttribute('data-video-id');
                    if(videoId == null) {
                        videoId = 'dQw4w9WgXcQ'; // ê¸°ë³¸ ë¹„ë””ì˜¤ ID ì„¤ì •
                    }
                    var videoUrl = 'https://www.youtube.com/embed/' + videoId;
                    document.getElementById('videoFrame').src = videoUrl;
                    modal.style.display = "flex"; // flexë¡œ ë³€ê²½
                    document.body.style.overflow = 'hide'; // ìŠ¤í¬ë¡¤ ë§‰ê¸°
                });

                document.getElementsByClassName('close')[0].addEventListener('click', function() {
                    var modal = document.getElementById('videoModal');
                    modal.style.display = "none";
                    document.getElementById('videoFrame').src = ""; // ë¹„ë””ì˜¤ ì¤‘ì§€
                    document.body.style.overflow = ''; // ìŠ¤í¬ë¡¤ ë³µì›
                });
            }
        });


        /* ìœ íŠœë¸Œ íŠ¸ë ˆì¼ëŸ¬ ê´€ë ¨ ëª¨ë‹¬ ë */

        // ë²„íŠ¼ í´ë¦­ ì‹œ ìŠ¤í‹¸ì»· ë˜ëŠ” ë¦¬ë·° í…Œì´ë¸”
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('img').forEach(function(img) {
                img.addEventListener('click', function() {
                    this.style.width = (this.style.width === '100%') ? 'auto' : '100%';
                });
            });

            var stillCutBtn = document.querySelector(".stillcut_btn");
            var reviewsBtn = document.querySelector(".reviews_btn");
            var stillCutDiv = document.getElementById("stillcut");
            var reviewsDiv = document.getElementById("reviews");

            stillCutBtn.addEventListener("click", function() {
                stillCutDiv.style.display = "block";
                reviewsDiv.style.display = "none";
                stillCutBtn.classList.add("clicked");
                reviewsBtn.classList.remove("clicked");
            });

            reviewsBtn.addEventListener("click", function() {
                stillCutDiv.style.display = "none";
                reviewsDiv.style.display = "block";
                reviewsBtn.classList.add("clicked");
                stillCutBtn.classList.remove("clicked");
            });
        });

        const movieId = $('#movieId').val();

        fetchMovieCredits(movieId);

        // ë¦¬ë·° ì‘ì„± ëª¨ë‹¬ì„ íŒì—… ì°½ìœ¼ë¡œ ì—´ê¸°
        function openReviewModal() {
            var member = JSON.parse(sessionStorage.getItem("userInfo"));

            if(member == null){
                alert("ë¡œê·¸ì¸ í›„ ì´ìš©í•´ì£¼ì„¸ìš”.");
                return;
            }else {
                var MemberEmail = member.email;
            }
            console.log(member)
            console.log(MemberEmail);

            // ëŒ“ê¸€ ì‘ì„± ì—¬ë¶€ í™•ì¸
            $.ajax({
                url: `/movies/hasCommented/${MemberEmail}/${movieId}`,
                method: 'GET',
                dataType: 'json',
                success: function(hasCommented) {
                    console.log("hasCommented ê°’:", hasCommented);

                    if (hasCommented) {
                        alert("ì´ë¯¸ ëŒ“ê¸€ì„ ì‘ì„±í•˜ì…¨ìŠµë‹ˆë‹¤.");
                    } else {
                        var reviewWindow = window.open('/review/' + movieId, 'ReviewModal', 'width=600,height=400');
                        var checkWindowClosed = setInterval(function () {
                            if (reviewWindow.closed) {
                                clearInterval(checkWindowClosed);
                                loadComments();
                            }
                        }, 500); // 0.5ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
                    }
                },
                error: function(xhr, status, error) {
                    console.error("ëŒ“ê¸€ ì‘ì„± ì—¬ë¶€ë¥¼ í™•ì¸í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", error);
                }
            });
        }

        //            ëŒ“ê¸€ë¦¬ìŠ¤íŠ¸    --------------------------------------------------
        const loadComments = () => {
            const emojiMap = {
                1: 'ğŸ˜¡',
                2: 'ğŸ˜ ',
                3: 'ğŸ˜',
                4: 'ğŸ˜Š',
                5: 'ğŸ˜'
            };

            $.ajax({
                url: `/movies/` + movieId,
                method: 'GET',
                dataType: 'json',
                success: (data) => {
                    console.log(data)
                    //í‰ì 
                    const movieDataSection = $('.movie_data_averageRating');
                    movieDataSection.html(`<h4>í‰ì </h4><p>${data.averageRating !== null ? data.averageRating : 0}</p>`);
                    //ëŒ“ê¸€ì •ë³´
                    const reviewsSection = $('#reviews-table');
                    reviewsSection.empty();
                    data.comments.forEach((comment) => {
                        appendReviewRow(reviewsSection, comment, emojiMap);
                    });
                },
                error: (xhr, status, error) => {
                    console.error("ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:", error);
                    $('#comments').append(`<div class="error"><p>ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p></div>`);
                }
            });
        };

        //ì´ë©”ì¼ ì²˜ë¦¬
        function maskEmail(email) {
            const atIndex = email.indexOf('@');
            let emailName = email.slice(0, atIndex);
            const emailDomain = email.slice(atIndex + 1);

            if (emailName.length > 3) {
                emailName = `${emailName.slice(0, -3)}***`;
            } else {
                emailName = '***';
            }

            return `${emailName}@${emailDomain}`;
        }

        function generateStars(grade) {
            return 'â˜…'.repeat(grade);
        }
        //ëŒ“ê¸€ ìˆ˜ë§Œí¼ ë°˜ë³µìƒì„±
        function appendReviewRow(reviewsSection, comment, emojiMap) {
            const maskedEmail = maskEmail(comment.memberEmail);
            const stars = generateStars(comment.grade);
            const emoji = emojiMap[comment.grade] || '';
            const member = JSON.parse(sessionStorage.getItem("userInfo"));
            const isOwner = member && member.email === comment.memberEmail;
            const reviewRow = `
        <tr>
            <td>
                <div>
                    <span>${emoji}</span>${stars}
                    <input type="radio" id="${comment.grade}-stars" value="${comment.grade}" checked="checked" />
                    <span>${new Date().toISOString().slice(0, 10)}</span>
                </div>
                <div style="display: flex; align-items: center;">
                    <h4>${maskedEmail}</h4><span style="margin-left: 40px">${comment.comment}</span>
                      ${isOwner ? `<button class="delete-btn" data-comment-id="${comment.cno}" style="margin-left: 20px;">ì‚­ì œ</button>` : ''}
                </div>
            </td>
        </tr>
    `;
            reviewsSection.append(reviewRow);
        }
        loadComments();

        $(document).on('click', '.delete-btn', function() {

            const cno = $(this).data('comment-id');
            console.log(cno);
            deleteComment(cno);
        });

        function deleteComment(cno) {
            $.ajax({
                url: `/movies/delete/${cno}`,
                method: 'DELETE',
                success: function(response) {
                    alert("ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    loadComments(); // ëŒ“ê¸€ ëª©ë¡ ë‹¤ì‹œ ë¡œë“œ
                },
                error: function(xhr, status, error) {
                    console.error("ëŒ“ê¸€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:", error);
                    alert("ëŒ“ê¸€ì„ ì‚­ì œí•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
            });
        }

    </script>

</th:block>
</body>
</html>