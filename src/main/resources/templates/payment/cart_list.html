<!DOCTYPE HTML>
<!--
	Helios by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
<html lang="en"
      layout:decorate="~{layout/layout_total}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Cinemacast</title>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1, user-scalable=no" name="viewport"/>
    <link href="/assets/css/main.css" rel="stylesheet"/>
    <link href="/assets/css/custom.css" rel="stylesheet"/>
    <link href="/assets/css/nav.css" rel="stylesheet"/>
    <noscript>
        <link href="/assets/css/noscript.css" rel="stylesheet"/>
    </noscript>
</head>
<body class="no-sidebar is-preload">
<th:block layout:fragment="content">
    <div id="page-wrapper">
        <!-- Main -->
        <div class="wrapper style1 list">
            <div class="container">
                <div class="cart_list">
                    <article class="special" id="main">
                        <header>
                            <h2><a href="#">장바구니</a></h2>
                            <p><b id="product_list_count">0</b>개 담겨있습니다.</p>
                        </header>
                        <section id="cart_list_section">
                            <div class="row">
                                <table class="default" id="cartTable">
                                    <tr>
                                        <th>상품</th>
                                        <th></th>
                                        <th>갯수</th>
                                        <th>합계</th>
                                        <th></th>
                                    </tr>
                                </table>
                            </div>
                            <div class="button_box">
                                <button class="button continue_btn" onclick="location.href='/snack/snackList'">쇼핑 계속하기
                                </button>
                                <div class="price_box">
                                    <h4 style="font-weight: bold">Total Price</h4>
                                    <p id="total_price2">0원</p>
                                </div>
                            </div>
                        </section>
                    </article>
                    <article class="special" id="pay">
                        <header>
                            <h2>Payment Info.</h2>
                        </header>
                        <section id="payment_section">
                            <div class="row">
                                <div id="payment">
                                    <p>Payment Method:</p>
                                    <button class="button">Credit Card</button>
                                </div>
                            </div>
                        </section>
                        <button class="button" onclick="requestPay()">결제하기</button>
                    </article>
                </div>
                <hr/>
                <div class="recommend">
                    <h3 style="font-size: 40px; margin-bottom: 1em">추천 상품</h3>
                    <div class="row">
                        <article class="col-2 col-12-mobile special" th:each="snack : ${snackList}">
                            <a class="image featured" th:href="@{/snack/detail(id=${snack.id})}">
                                <img th:alt="${snack.snack_alt}"
                                     th:src="@{/images/menu/{image}(image=${snack.snack_image})}"/>
                            </a>
                            <header>
                                <h3>
                                    <a th:href="@{/snack/detail(id=${snack.id})}" th:text="${snack.snack_nm}"></a>
                                </h3>
                            </header>
                        </article>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/jquery.dropotron.min.js"></script>
    <script src="/assets/js/jquery.scrolly.min.js"></script>
    <script src="/assets/js/jquery.scrollex.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>

    <!--결제 프로그램 쓰려면 jquery 필요-->
    <script src="https://code.jquery.com/jquery-1.12.4.min.js" type="text/javascript"></script>
    <script src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js" type="text/javascript"></script>
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>

    <script th:inline="javascript">
        let currentPrice = 0; // 결제시 사용할 변수

        document.addEventListener("DOMContentLoaded", function() {
            //localstorage에 저장된 snackCart 장바구니 개수
            function getCartItemCount() {
                let cartItemCount = 0;
                for(let i = 0; i < localStorage.length; i++) {
                    let key = localStorage.key(i);
                    if(key.startsWith("snackCart")) {
                        cartItemCount++;
                    }
                }
                return cartItemCount;
            }

            let cartItemCount = getCartItemCount();
            document.getElementById("product_list_count").textContent = cartItemCount;

            // cart table값 가져오기
            let cartTable = document.getElementById("cartTable");
            let totalPrice2 = 0;

            for(let i = 0; i < localStorage.length; i++) {
                let key = localStorage.key(i);
                if(key.startsWith("snackCart")) {
                    let item = JSON.parse(localStorage.getItem(key));

                    // data가 배열이라면 각 요소를 확인
                    item.forEach(item => {
                        let row = cartTable.insertRow();

                        let imgCell = row.insertCell(0);
                        let nameCell = row.insertCell(1);
                        let countCell = row.insertCell(2);
                        let priceCell = row.insertCell(3);
                        let deleteCell = row.insertCell(4);

                        imgCell.innerHTML = `<img alt="${item.alt}" src="/images/menu/${item.image}">`;
                        nameCell.innerHTML = `<a href="/snack/detail?id=${item.id}"><span class="itemInfo" data-item-id="${item.id}">${item.name}</span></a>`;
                        countCell.innerHTML = `
                                    <div class="count_box">
                                        <button class="discount">-</button>
                                        <p class="countValue">${item.count}</p>
                                        <button class="upcount">+</button>
                                    </div>`;
                        priceCell.innerHTML = `
                            <p class="calc_price">${item.count} * ${item.price}</p>
                            <p class="total_price">${(item.count * item.price)}원</p>
                        `;
                        deleteCell.innerHTML = `<img alt="상품 삭제 버튼" src="/images/delete.png" onclick="removeItem('${key}')"/>`;

                        totalPrice2 += item.count * item.price; // 진짜 최종 totalPrice2
                        currentPrice = totalPrice2; // 현재 Price를을 전역 변수에 저장
                    });
                }
            }

            // 주문 수량 count + 합계
            const countElements = document.querySelectorAll('.countValue');
            const itemElements = document.querySelectorAll('.itemInfo');
            const totalPrice2Element = document.getElementById("total_price2");

            function updateTotalPrice() {
                totalPrice2 = 0;
                countElements.forEach(countElement => {
                    let count = parseInt(countElement.textContent);
                    let price = parseInt(countElement.parentElement.parentElement.nextElementSibling.firstElementChild.textContent.split('*')[1].trim());
                    totalPrice2 += count * price;
                });
                totalPrice2Element.textContent = totalPrice2.toLocaleString() + '원';
                currentPrice = totalPrice2; // 현재 Price를을 전역 변수에 저장
            }

            countElements.forEach((countElement, index) => {
                const discountButton = countElement.parentElement.querySelector('.discount');
                const upcountButton = countElement.parentElement.querySelector('.upcount');

                const itemElement = itemElements[index]; // 해당 인덱스에 해당하는 아이템 요소 가져오기
                const itemId = itemElement.getAttribute('data-item-id'); // 해당 아이템의 ID 값 가져오기

                discountButton.addEventListener("click", function() {
                    let count = parseInt(countElement.textContent);
                    if(count > 1) {
                        count--;
                        countElement.textContent = count;

                        // 가격 업데이트
                        const price = parseInt(countElement.parentElement.parentElement.nextElementSibling.firstElementChild.textContent.split('*')[1].trim());
                        const calcPriceElement = countElement.parentElement.parentElement.nextElementSibling.firstElementChild;
                        const totalPriceElement = countElement.parentElement.parentElement.nextElementSibling.lastElementChild;

                        calcPriceElement.textContent = `${count} * ${price}`;
                        totalPriceElement.textContent = `${(count * price).toLocaleString()}원`;

                        updateTotalPrice();
                        updateLocalStorage(itemId, count);
                    }
                });

                upcountButton.addEventListener("click", function() {
                    let count = parseInt(countElement.textContent);
                    count++;
                    countElement.textContent = count;

                    // 가격 업데이트
                    const price = parseInt(countElement.parentElement.parentElement.nextElementSibling.firstElementChild.textContent.split('*')[1].trim());
                    const calcPriceElement = countElement.parentElement.parentElement.nextElementSibling.firstElementChild;
                    const totalPriceElement = countElement.parentElement.parentElement.nextElementSibling.lastElementChild;

                    calcPriceElement.textContent = `${count} * ${price}`;
                    totalPriceElement.textContent = `${(count * price).toLocaleString()}원`;

                    updateTotalPrice();
                    updateLocalStorage(itemId, count);
                });
            });

            // 초기 총 합계 설정
            updateTotalPrice();

            // 장바구니 아이템 수량 업데이트 함수
            function updateLocalStorage(itemId, count) {
                const cartKEYID = parseInt(itemId, 10); // Convert itemId to integer
                const saveCount = parseInt(count, 10); // Convert count to integer
                const key = `snackCart${cartKEYID}`; // Dynamically create the key

                // Retrieve the item array with the given key
                let itemArray = JSON.parse(localStorage.getItem(key)) || [];

                // Find the item in the array
                const itemIndex = itemArray.findIndex(item => item.id === cartKEYID);

                if(itemIndex !== -1) {
                    // If the item exists, update its count
                    itemArray[itemIndex].count = saveCount;
                } else {
                    // If the item doesn't exist
                    console.log("Adding new item to cart with ID:", cartKEYID);
                }

                // Save the updated item array back to localStorage
                localStorage.setItem(key, JSON.stringify(itemArray));
            }
        });

        function removeItem(key) {
            localStorage.removeItem(key);
            location.reload(); // 페이지를 새로고침하여 테이블을 업데이트
        }

        <!-- 결제 프로그램 관련 시작 -->
        const html5InicisKey = [[${html5InicisKey}]];
        const memberEmail = [[${memberInfo[0]}]];
        const memberIdx = [[${memberInfo[1]}]];

        function requestPay() { // 값 수정예정
            const totalPriceElement = document.getElementById("total_price");
            // const self = this;
            // if(self.price == null || self.price == '') {
            //     alert("금액을 입력하세요.")
            // } else if(self.contractformcheck == false) {
            //     alert("이용약관에 동의 해주세요.")
            // } else {
            IMP.init(html5InicisKey); // 고객사 식별코드
            IMP.request_pay({
                pg: "html5_inicis", //"{PG사 코드}.{상점 ID}",
                pay_method: "card",
                merchant_uid: `CA-${crypto.randomUUID()}`, // 상점에서 생성한 주문 고유 번호
                name: "장바구니 결제", // 주문명
                amount: currentPrice, // 결제 금액
                buyer_email: memberEmail,
                buyer_name: memberIdx,
                // buyer_tel: "010-0000-0000",
                m_redirect_url: '/payment/complete'
            }, function(rsp) {
                // let result = "";
                if(rsp.success) {
                    var msg = "결제가 완료되었습니다.";
                    msg += "고유ID : " + rsp.imp_uid;
                    msg += "상점 거래ID : " + rsp.merchant_uid;
                    msg += "결제 금액 : " + rsp.paid_amount;
                    msg += "카드 승인번호 : " + rsp.apply_num;
                    $.ajax({
                        type: "GET",
                        url: "payment/complete",
                        data: {
                            "amount": money
                        },
                    });

                    // result = "0";
                    //
                    // const form = new FormData();
                    // form.append("impuid", rsp.imp_uid)
                    // form.append("merchantuid", rsp.merchant_uid)
                    // form.append("paidamount", rsp.amount)
                    // form.append("applynum", rsp.apply_num)
                    // form.append("email", rsp.buyer_email)
                    //
                    // console.log(form)

                    // self.$axios.post("http://localhost:8080/payment/complete" + rsp.email, form)
                    //     .then(function(res) {
                    //         if(res.status === 200) {
                    //             console.log(res)
                    //             self.close();
                    //             window.location.reload(true);
                    //         }
                    //     });
                } else {
                    var msg = "결제에 실패하였습니다.";
                    msg += "에러내용 : " + rsp.error_msg;
                    // result = "1";
                    // self.contractformcheck = false;
                    // self.formattedPrice = "";
                    // self.price = 0;
                    // self.isPlaceholderVisible = true;
                }
                // if(result === "0") {
                //     alert("성공")
                // }
                // self.contractformcheck = false
                alert(msg);
                // document.location.href = "/" // alert창 확인 후 이동할 url
            });
        }
        <!--결제 프로그램 관련 끝-->
    </script>
</th:block>
</body>
</html>